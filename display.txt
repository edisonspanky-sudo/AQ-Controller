#ifndef DISPLAY_H
#define DISPLAY_H

#include <PCF8574.h>
#include <RTClib.h>
#include "config.h"
#include "pin_definitions.h"

// External references
extern PCF8574 buttonBox;
extern RTC_DS3231 rtc;
extern float tempSump;
extern float tempDisplay;
extern bool heaterPrimaryOn;
extern bool emergencyStop;
extern bool feedModeActive;
extern bool photoModeActive;
extern bool alarmSilenced;
extern bool atoRunning;
extern bool atoTimeoutAlarm;
extern bool atoReservoirAlarm;
extern unsigned long atoStartTime;
extern LightMode currentLightMode;
extern CloudState cloudState;
extern bool scheduledLightsEnabled;
extern int currentRampStep;
extern unsigned long feedModeStartTime;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LED CONTROL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

void updateLEDs() {
  // Blinker state (persists across calls)
  static uint32_t lastBlink = 0;
  static bool blinkState = false;

  // Default OFF
  buttonBox.digitalWrite(LED_RED, LOW);
  buttonBox.digitalWrite(LED_YELLOW, LOW);
  buttonBox.digitalWrite(LED_BLUE, LOW);
  buttonBox.digitalWrite(LED_GREEN, LOW);

  // Highest priority: E-stop
  if (emergencyStop) {
    // Blink red during E-stop
    uint32_t now = millis();
    if (now - lastBlink >= 500) {
      lastBlink = now;
      blinkState = !blinkState;
    }
    buttonBox.digitalWrite(LED_RED, blinkState ? HIGH : LOW);

    // Optional: quiet â€œtickâ€ beep when not silenced (comment out if annoying)
    // if (blinkState && !alarmSilenced) tone(BUZZER_PIN, 2000, 30);

    return;
  }

  // Alarm/fault indicators (ATO faults for now)
  bool atoFault = (atoTimeoutAlarm || atoReservoirAlarm);

  // Blue = ACK/silenced OR â€œattention neededâ€
  if (atoFault && alarmSilenced) {
    buttonBox.digitalWrite(LED_BLUE, HIGH);
  }

  // Red = fault active and not silenced
  if (atoFault && !alarmSilenced) {
    buttonBox.digitalWrite(LED_RED, HIGH);
  }

  // Yellow = feed mode
  if (feedModeActive) {
    buttonBox.digitalWrite(LED_YELLOW, HIGH);
  }

  // Green = normal operation (no E-stop, no ATO faults)
  if (!atoFault) {
    buttonBox.digitalWrite(LED_GREEN, HIGH);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATUS DISPLAY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

void printStatus() {
  static unsigned long lastPrint = 0;
  
  if (millis() - lastPrint < 5000) return;
  lastPrint = millis();
  
  Serial.println("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
  Serial.println("â•‘      AQUARIUM CONTROLLER STATUS       â•‘");
  Serial.println("â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£");
  
  DateTime now = rtc.now();
  Serial.print("â•‘ Time: ");
  if (now.hour() < 10) Serial.print("0");
  Serial.print(now.hour());
  Serial.print(":");
  if (now.minute() < 10) Serial.print("0");
  Serial.print(now.minute());
  Serial.print(":");
  if (now.second() < 10) Serial.print("0");
  Serial.print(now.second());
  Serial.println("                            â•‘");
  
  Serial.println("â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£");
  
  Serial.print("â•‘ Sump Temp:     ");
  Serial.print(tempSump, 1);
  Serial.print("Â°F");
  if (tempSump < 10) Serial.print("  ");
  else if (tempSump < 100) Serial.print(" ");
  Serial.println("                â•‘");
  
  Serial.print("â•‘ Display Temp:  ");
  Serial.print(tempDisplay, 1);
  Serial.print("Â°F");
  if (tempDisplay < 10) Serial.print("  ");
  else if (tempDisplay < 100) Serial.print(" ");
  Serial.println("                â•‘");
  
  Serial.print("â•‘ Target:        ");
  Serial.print(TARGET_TEMP, 1);
  Serial.println("Â°F                 â•‘");
  
  Serial.print("â•‘ Primary Heater: ");
  Serial.print(heaterPrimaryOn ? "ON " : "OFF");
  Serial.println("                   â•‘");
  
  Serial.println("â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£");
  
  Serial.print("â•‘ Light Mode:    ");
  switch(currentLightMode) {
    case NIGHT_MODE:
      Serial.print("NIGHT MODE");
      break;
    case SUNRISE_RAMPING:
      Serial.print("SUNRISE (");
      Serial.print((currentRampStep * 100) / RAMP_STEPS);
      Serial.print("%)");
      break;
    case FULL_DAYLIGHT:
      Serial.print("DAYLIGHT");
      break;
    case SUNSET_RAMPING:
      Serial.print("SUNSET (");
      Serial.print((currentRampStep * 100) / RAMP_STEPS);
      Serial.print("%)");
      break;
  }
  Serial.println("           â•‘");
  
  if (cloudState != NO_CLOUD) {
    Serial.print("â•‘ Cloud:         ");
    switch(cloudState) {
      case CLOUD_DIMMING:
        Serial.print("DIMMING");
        break;
      case CLOUD_HOLDING:
        Serial.print("PASSING");
        break;
      case CLOUD_BRIGHTENING:
        Serial.print("BRIGHTENING");
        break;
    }
    Serial.println("             â•‘");
  }
  
  Serial.print("â•‘ Schedule:      ");
  Serial.print(scheduledLightsEnabled ? "ENABLED" : "DISABLED");
  Serial.println("              â•‘");
  
  Serial.println("â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£");
  
  Serial.print("â•‘ ATO Status:    ");
  if (atoReservoirAlarm) {
    Serial.println("RESERVOIR EMPTY        â•‘");
  } else if (atoTimeoutAlarm) {
    Serial.println("TIMEOUT ALARM          â•‘");
  } else if (atoRunning) {
    Serial.print("RUNNING (");
    int runtime = (millis() - atoStartTime) / 1000;
    if (runtime < 10) Serial.print(" ");
    Serial.print(runtime);
    Serial.println(" sec)       â•‘");
  } else {
    Serial.println("STANDBY                â•‘");
  }
  
  Serial.println("â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£");
  
  if (emergencyStop) {
    Serial.println("â•‘ ğŸ”´ E-STOP ACTIVE                      â•‘");
  }
  if (feedModeActive) {
    int remaining = (FEED_MODE_DURATION - (millis() - feedModeStartTime)) / 1000;
    Serial.print("â•‘ ğŸŸ FEED MODE (");
    if (remaining < 100) Serial.print(" ");
    if (remaining < 10) Serial.print(" ");
    Serial.print(remaining);
    Serial.println(" sec left)         â•‘");
  }
  if (photoModeActive) {
    Serial.println("â•‘ ğŸ“¸ PHOTO MODE ACTIVE                  â•‘");
  }
  if (alarmSilenced) {
    Serial.println("â•‘ ğŸ”‡ ALARM SILENCED                     â•‘");
  }
  
  Serial.println("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
}


#endif
